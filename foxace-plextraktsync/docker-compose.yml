version: "3.7"
services:
  server:
    image: ghcr.io/taxel/plextraktsync:latest
    container_name: foxace-plextraktsync
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - ${APP_DATA_DIR}/data/config:/app/config
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "=== PlexTraktSync ==="

        # Verifier si login effectue
        if [ ! -f /app/config/.pytrakt.json ]; then
          echo ""
          echo "Configuration requise!"
          echo "Lancez cette commande pour configurer:"
          echo ""
          echo "  ssh umbrel@192.168.1.60"
          echo "  docker exec -it foxace-plextraktsync plextraktsync login"
          echo ""
          echo "Puis redemarrez l'app."
          echo ""
          # Attendre indefiniment
          tail -f /dev/null
        fi

        echo "Configuration trouvee. Demarrage sync..."

        # Boucle de sync toutes les 6h
        while true; do
          echo "[$(date)] Lancement sync Plex <-> Trakt..."
          plextraktsync sync || true
          echo "[$(date)] Sync termine. Prochaine sync dans 6 heures."
          sleep 21600
        done
    restart: on-failure
    networks:
      default:
        aliases:
          - plextraktsync

networks:
  default:
    name: umbrel_main_network
    external: true
