version: "3.7"
services:
  app_proxy:
    environment:
      APP_HOST: foxace-openclaw_gateway_1
      APP_PORT: 18789
    container_name: foxace-openclaw_app_proxy_1
  gateway:
    image: ghcr.io/openclaw/openclaw:latest
    user: "0:0"
    environment:
      OPENCLAW_GATEWAY_TOKEN: "${APP_PASSWORD}"
      OPENCLAW_STATE_DIR: /data/.openclaw
      OPENCLAW_WORKSPACE_DIR: /data/workspace
      OPENCLAW_LOG_DIR: /data/logs
      NODE_ENV: production
      HOME: /home/node
      NPM_CONFIG_USERCONFIG: /data/.npmrc
    volumes:
      - "${APP_DATA_DIR}/data:/data"
    restart: on-failure
    init: true
    stop_grace_period: 30s
    entrypoint: /bin/sh
    command:
      - -c
      - >
        apt-get update -qq && apt-get install -y -qq jq ripgrep ffmpeg gosu >/dev/null 2>&1 ;

        mkdir -p /data/.openclaw &&

        if [ ! -f /data/.openclaw/openclaw.json ]; then
          echo '{"gateway":{"controlUi":{"allowInsecureAuth":true,"dangerouslyDisableDeviceAuth":true}}}' > /data/.openclaw/openclaw.json ;
        fi &&

        chown -R node:node /home/node/ &&

        exec gosu node node dist/index.js gateway --bind lan --port 18789
        --allow-unconfigured
    container_name: foxace-openclaw_gateway_1
