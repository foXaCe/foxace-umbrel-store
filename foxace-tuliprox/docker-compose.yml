version: "3.7"

services:
  # Init container to create default config and download web UI
  tuliprox-init:
    image: alpine
    volumes:
      - ${APP_DATA_DIR}/data/config:/config
      - ${APP_DATA_DIR}/data/web:/web
    command:
      - sh
      - -c
      - |
        # Create config.yml if not exists
        if [ ! -f /config/config.yml ]; then
          cat > /config/config.yml << 'CONFIGEOF'
        threads: 2

        api:
          host: 0.0.0.0
          port: 8901
          web_root: /app/web

        working_dir: /app/data
        backup_dir: /app/backup

        update_on_boot: false

        web_ui:
          enabled: true
          user_ui_enabled: true
        CONFIGEOF
          echo "Created default config.yml"
        fi

        # Create source.yml if not exists
        if [ ! -f /config/source.yml ]; then
          echo "sources: []" > /config/source.yml
          echo "Created default source.yml"
        fi

        # Download web UI if not exists
        if [ ! -d /web/assets ]; then
          echo "Downloading web UI..."
          cd /tmp
          wget -q https://github.com/euzu/tuliprox/releases/download/v3.2.0/tuliprox_3.2.0_linux_x86_64.tgz
          tar xzf tuliprox_3.2.0_linux_x86_64.tgz
          cp -r tuliprox_3.2.0_linux_x86_64/web/* /web/
          echo "Web UI installed"
        fi
    networks:
      default:

  tuliprox:
    image: ghcr.io/euzu/tuliprox:latest
    restart: on-failure
    depends_on:
      - tuliprox-init
    working_dir: /app
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    ports:
      - "8901:8901"
    volumes:
      - ${APP_DATA_DIR}/data/data:/app/data
      - ${APP_DATA_DIR}/data/config:/app/config
      - ${APP_DATA_DIR}/data/backup:/app/backup
      - ${APP_DATA_DIR}/data/downloads:/app/downloads
      - ${APP_DATA_DIR}/data/web:/app/web
      - /home/umbrel/umbrel/home:/mnt:rslave
    networks:
      default:
        aliases:
          - tuliprox

networks:
  default:
    name: umbrel_main_network
    external: true
